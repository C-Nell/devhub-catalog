schemaVersion: 2.2.2
metadata:
  name: backstage-devspace
components:
  - name: tools
    container:
      image: registry.redhat.io/devspaces/udi-rhel9:3.23
      mountSources: true
      sourceMapping: /projects
      cpuLimit: "2"
      memoryLimit: "4Gi"
      env:
        - name: HOST
          value: "0.0.0.0"
      endpoints:
        - name: backend
          targetPort: 7007
          exposure: public
          protocol: http
          secure: true
  
  # Dedicated init container for yarn install
  - name: yarn-installer
    container:
      image: registry.redhat.io/devspaces/udi-rhel9:3.23
      mountSources: true
      sourceMapping: /projects
      # Define the command directly in the container
      command: ['bash', '-lc']
      args:
        - |
          set -e
          cd ${PROJECTS_ROOT}/devhub-catalog
          (
              set -euo pipefail
              echo "[yarn install] started: $(date)"
              echo "[yarn install] node: $(node -v 2>&1 || true)"
              export npm_config_nodedir=/usr && node .yarn/releases/yarn-*.cjs install
              echo "[yarn install] finished: $(date)"
          ) >> **YARN-INSTALL**.log 2>&1 &
          disown
          echo "[yarn install] running in background; see .**YARN-INSTALL**.log"

commands:
  - id: yarn-install-background
    apply:
      component: yarn-installer
        
events:
  preStart:
    - yarn-install-background
