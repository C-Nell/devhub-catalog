name: Auto create promotion PR
on:
  pull_request:
    types: [closed]
    branches:
      - sssd-rhdh-sbx
      - sssd-rhdh-dev
      - sssd-rhdh-preprod
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create-promotion-pr:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    concurrency:
      group: promote-from-${{ github.base_ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Process next environment
        id: next-env
        run: |
          if [[ "${{ github.base_ref }}" == "sssd-rhdh-sbx" ]]; then
            echo "target=sssd-rhdh-dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.base_ref }}" == "sssd-rhdh-dev" ]]; then
            echo "target=sssd-rhdh-preprod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.base_ref }}" == "sssd-rhdh-preprod" ]]; then
            echo "target=main" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request to next environment
        if: steps.next-env.outputs.target != ''
        run: |
          gh pr create \
            --base ${{ steps.next-env.outputs.target }} \
            --head ${{ github.base_ref }} \
            --title "âœ… Promote to ${{ steps.next-env.outputs.target }}" \
            --body "Auto-promotion from ${{ github.base_ref }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
